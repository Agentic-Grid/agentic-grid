# Database Contracts
# Owner: DATA | Consumers: BACKEND
# Last Updated: [DATE]
#
# RULES:
# - Every foreign key MUST have an index
# - Every table MUST have created_at and updated_at
# - Use UUIDs for primary keys
# - Document query patterns for complex operations

version: "1.0"
database: postgresql

# =============================================================================
# TABLES
# =============================================================================

tables:
  users:
    description: User accounts
    columns:
      id:
        type: UUID
        primaryKey: true
        default: gen_random_uuid()
      email:
        type: VARCHAR(255)
        nullable: false
        unique: true
      password_hash:
        type: VARCHAR(255)
        nullable: false
      name:
        type: VARCHAR(100)
        nullable: false
      role:
        type: VARCHAR(20)
        nullable: false
        default: "'user'"
        check: "role IN ('user', 'admin')"
      status:
        type: VARCHAR(20)
        nullable: false
        default: "'active'"
        check: "status IN ('active', 'inactive', 'banned')"
      email_verified_at:
        type: TIMESTAMP WITH TIME ZONE
        nullable: true
      last_login_at:
        type: TIMESTAMP WITH TIME ZONE
        nullable: true
      created_at:
        type: TIMESTAMP WITH TIME ZONE
        nullable: false
        default: NOW()
      updated_at:
        type: TIMESTAMP WITH TIME ZONE
        nullable: false
        default: NOW()
      deleted_at:
        type: TIMESTAMP WITH TIME ZONE
        nullable: true
        description: Soft delete timestamp

    indexes:
      - name: idx_users_email
        columns: [email]
        unique: true
      - name: idx_users_role
        columns: [role]
      - name: idx_users_status
        columns: [status]
      - name: idx_users_deleted_at
        columns: [deleted_at]
        where: "deleted_at IS NULL"

  refresh_tokens:
    description: JWT refresh tokens for session management
    columns:
      id:
        type: UUID
        primaryKey: true
        default: gen_random_uuid()
      user_id:
        type: UUID
        nullable: false
        references: users(id)
        onDelete: CASCADE
      token_hash:
        type: VARCHAR(255)
        nullable: false
        unique: true
      expires_at:
        type: TIMESTAMP WITH TIME ZONE
        nullable: false
      revoked_at:
        type: TIMESTAMP WITH TIME ZONE
        nullable: true
      created_at:
        type: TIMESTAMP WITH TIME ZONE
        nullable: false
        default: NOW()

    indexes:
      - name: idx_refresh_tokens_user_id
        columns: [user_id]
      - name: idx_refresh_tokens_token_hash
        columns: [token_hash]
        unique: true
      - name: idx_refresh_tokens_expires_at
        columns: [expires_at]

# =============================================================================
# RELATIONSHIPS
# =============================================================================

relationships:
  user_refresh_tokens:
    type: one-to-many
    from: users
    to: refresh_tokens
    foreignKey: user_id
    description: A user can have multiple refresh tokens (multiple devices)

# =============================================================================
# QUERY PATTERNS
# =============================================================================

queries:
  findUserByEmail:
    description: Find user by email (login flow)
    sql: |
      SELECT * FROM users 
      WHERE email = $1 
      AND deleted_at IS NULL
    indexes_used:
      - idx_users_email
    expectedRows: 0-1
    notes: Unique constraint ensures at most one result

  findUserWithTokens:
    description: Get user with their refresh tokens (session management)
    pattern: |
      User.findByPk(userId, {
        include: [{ model: RefreshToken, as: 'refreshTokens' }]
      })
    indexes_used:
      - users.id (PK)
      - idx_refresh_tokens_user_id
    notes: Eager loading prevents N+1

  listActiveUsers:
    description: Paginated list of active users (admin view)
    sql: |
      SELECT * FROM users
      WHERE status = 'active'
      AND deleted_at IS NULL
      ORDER BY created_at DESC
      LIMIT $1 OFFSET $2
    indexes_used:
      - idx_users_status
      - idx_users_deleted_at
    notes: Consider composite index if frequently used

  cleanupExpiredTokens:
    description: Remove expired refresh tokens (scheduled job)
    sql: |
      DELETE FROM refresh_tokens
      WHERE expires_at < NOW()
      OR revoked_at IS NOT NULL
    indexes_used:
      - idx_refresh_tokens_expires_at
    frequency: Daily cron job

# =============================================================================
# MIGRATIONS HISTORY
# =============================================================================

migrations:
  - id: "001"
    name: create_users
    description: Initial users table
    appliedAt: null

  - id: "002"
    name: create_refresh_tokens
    description: JWT refresh tokens table
    appliedAt: null

# =============================================================================
# DATA INTEGRITY RULES
# =============================================================================

integrityRules:
  - rule: "Foreign keys must have ON DELETE behavior defined"
  - rule: "Soft deletes use deleted_at timestamp, not physical deletion"
  - rule: "All timestamps use TIMESTAMP WITH TIME ZONE"
  - rule: "Enum-like fields use CHECK constraints, not DB enums"
  - rule: "String lengths are explicitly defined (no TEXT for user input)"
